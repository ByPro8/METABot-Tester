<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MetaBot Lab — Cluster</title>
  <link rel="stylesheet" href="/static/cluster.css" />
</head>
<body>
  <div id="processingOverlay" class="overlay" style="display:none;">
    <div class="overlay__box">
      <div class="overlay__spinner"></div>
      <div class="overlay__title">Processing…</div>
      <div class="overlay__sub">Uploading and grouping PDFs. Please wait.</div>
    </div>
  </div>

  <div class="app">
    <header class="header">
      <div class="header__left">
        <div class="logo">MetaBot Lab</div>
        <div class="sub">Cluster PDFs by “available metadata keys” (presence only) — PythonMeta vs ExifTool</div>
      </div>
      <div class="header__right">
        <a class="pill" href="/" rel="noreferrer">home</a>
        <a class="pill" href="/healthz" target="_blank" rel="noreferrer">healthz</a>
      </div>
    </header>

    <main class="main">
      <section class="card">
        <div class="card__title">Cluster upload</div>
        <form class="form" action="/cluster" method="post" enctype="multipart/form-data">
          <input class="file" type="file" name="pdfs" accept="application/pdf" multiple required />
</form>

        {% if error %}
          <div class="error">{{ error }}</div>
        {% endif %}

        {% if cluster %}
          <div class="hint">Uploaded: <b>{{ cluster.files|length }}</b> PDFs. Click any filename to open the PDF in a new tab.</div>
        {% endif %}
      </section>

      {% if cluster %}
      <section class="card">
        <div class="card__title">Groups</div>

        <div class="tabs">
          <button type="button" class="tab active" data-tab="pygrp">PythonMeta key-sets</button>
          <button type="button" class="tab" data-tab="exgrp">ExifTool key-sets</button>
        </div>

        <div class="pane show" id="tab-pygrp">
          <div class="muted">Groups are based on which metadata keys exist (values ignored). Same keys ⇒ same group.</div>

          {% for g in cluster.python_groups %}
            <div class="group">
              <div class="group__head">
                <div class="badge same">Group {{ g["label"] }}</div>
                <div class="muted">{{ g["count"] }} file(s) • {{ g["keys"]|length }} keys</div>
              </div>

              <div class="group__files">
                {% for f in g["files"] %}
                  <a class="filelink" href="/view/{{ f }}" target="_blank" rel="noreferrer">{{ f }}</a>
                {% endfor %}
              </div>

              <details class="group__keys">
                <summary>Show keys</summary>
                {% for sec in g["keys_grouped"] %}
                  <div class="sectionHead">--- {{ sec.section }} ---</div>
                  <ul class="keylist">
                    {% for t in sec.tags %}
                      <li><code>{{ t }}</code></li>
                    {% endfor %}
                  </ul>
                {% endfor %}
              </details>
            </div>
          {% endfor %}
        </div>

        <div class="pane" id="tab-exgrp">
          <div class="muted">Same idea, but for ExifTool output keys only.</div>

          {% for g in cluster.exif_groups %}
            <div class="group">
              <div class="group__head">
                <div class="badge same">Group {{ g["label"] }}</div>
                <div class="muted">{{ g["count"] }} file(s) • {{ g["keys"]|length }} keys</div>
              </div>

              <div class="group__files">
                {% for f in g["files"] %}
                  <a class="filelink" href="/view/{{ f }}" target="_blank" rel="noreferrer">{{ f }}</a>
                {% endfor %}
              </div>

              <details class="group__keys">
                <summary>Show keys</summary>
                {% for sec in g["keys_grouped"] %}
                  <div class="sectionHead">--- {{ sec.section }} ---</div>
                  <ul class="keylist">
                    {% for t in sec.tags %}
                      <li><code>{{ t }}</code></li>
                    {% endfor %}
                  </ul>
                {% endfor %}
              </details>
            </div>
          {% endfor %}
        </div>

      </section>
      {% else %}
      <section class="card">
        <div class="muted">Upload multiple PDFs to see groups A/B/C…</div>
      </section>
      {% endif %}
    </main>
  </div>

  <script src="/static/app.js?v=20260212"></script>

  <script>
    function showProcessingOverlay() {
      var el = document.getElementById("processingOverlay");
      if (el) el.style.display = "flex";
    }
    document.addEventListener("submit", function(e) {
      showProcessingOverlay();
    }, true);
    document.addEventListener("change", function(e) {
      var t = e.target;
      if (t && t.matches && t.matches('input[type="file"]')) {
        if (t.files && t.files.length > 0) showProcessingOverlay();
      }
    }, true);
  </script>

</body>
</html>
